<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MailGenius</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
          href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
          rel="stylesheet"
  />
  <style>
    :root {
      color-scheme: light;
      --ink: #1d1e22;
      --muted: #6a6f7a;
      --accent: #f05d23;
      --accent-2: #f7c45d;
      --card: rgba(255, 255, 255, 0.92);
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
      --ring: rgba(240, 93, 35, 0.25);
      --border: rgba(29, 30, 34, 0.12);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      height: 100vh; /* å¼ºåˆ¶å…¨å±é«˜åº¦ */
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      color: var(--ink);
      background:
              radial-gradient(circle at 10% 10%, rgba(240, 93, 35, 0.12), transparent 40%),
              linear-gradient(180deg, #f8f2e6 0%, #f2efe9 100%);
      overflow: hidden; /* ç¦æ­¢ body æ»šåŠ¨ï¼Œäº¤ç»™å†…éƒ¨å®¹å™¨ */
    }

    /* æ ¸å¿ƒå¸ƒå±€å®¹å™¨ */
    .frame {
      max-width: 1600px;
      width: 96%;
      margin: 0 auto;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
    }

    header {
      flex-shrink: 0;
      margin-bottom: 20px;
      padding: 0 12px;
      position: relative;
    }

    .eyebrow { text-transform: uppercase; letter-spacing: 0.2em; font-size: 12px; color: var(--muted); }
    h1 { margin: 0; font-size: 2rem; line-height: 1.1; }
    .subtitle { color: var(--muted); font-size: 0.95rem; }

    /* å¡ç‰‡é€šç”¨ */
    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.6);
    }

    /* é¦–é¡µå±…ä¸­ç‰¹æ®Šå¤„ç† */
    #home-view {
      margin: auto; /* å‚ç›´æ°´å¹³å±…ä¸­ */
      width: 100%;
      max-width: 700px;
    }

    /* æŒ‰é’®ä¸è¡¨å• */
    button {
      cursor: pointer; border: none; border-radius: 10px; padding: 10px 18px;
      font-weight: 600; font-size: 0.9rem; background: var(--ink); color: #fff;
      transition: all 0.2s ease;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
    button.secondary { background: transparent; color: var(--ink); border: 1px solid var(--border); box-shadow: none; }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    input, select, textarea {
      font-family: inherit; width: 100%; padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--border); background: rgba(255,255,255,0.7); outline: none;
      font-size: 0.95rem; transition: border 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--ring); background: #fff; }

    .hidden { display: none !important; }

    .status-pill { display: inline-flex; align-items: center; gap: 8px; padding: 5px 12px; border-radius: 99px; font-size: 0.85rem; background: rgba(0,0,0,0.05); }
    .status-pill[data-active="true"] { background: rgba(240, 93, 35, 0.1); color: var(--ink); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; }
    .status-pill[data-active="true"] .status-dot { background: var(--accent); }

    /* ================= Manager è§†å›¾å¸ƒå±€ (Split View) ================= */
    #manager-view {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* å…è®¸ Flex å­é¡¹æ»šåŠ¨ */
    }

    .manager-topbar {
      flex-shrink: 0;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; padding: 0 8px;
    }

    /* é¡¶éƒ¨è‡ªåŠ¨åŒæ­¥å°ç»„ä»¶æ ·å¼ */
    .sync-widget {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-right: 8px;
    }

    .sync-widget label {
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    .sync-widget input[type="number"] {
      padding: 4px 8px;
      width: 60px;
      text-align: center;
      border-radius: 6px;
      font-size: 0.85rem;
      height: auto;
      background: #f9f9f9;
    }

    .manager-layout {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1fr) 420px; /* å·¦ä¾§è‡ªé€‚åº”ï¼Œå³ä¾§å›ºå®š 420px */
      gap: 20px;
      min-height: 0; /* å…³é”®ï¼šå…è®¸ç½‘æ ¼å†…æ»šåŠ¨ */
      padding-bottom: 10px;
    }

    /* === å·¦ä¾§ï¼šé‚®ä»¶åˆ—è¡¨ä¸è¯¦æƒ… (å¡ç‰‡é£æ ¼) === */
    .mail-section {
      display: flex;
      flex-direction: column;
      background: var(--card);
      border-radius: 20px;
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.5);
    }

    .mail-content-wrapper {
      flex: 1;
      overflow-y: auto; /* å‚ç›´æ»šåŠ¨ */
      display: flex;
      flex-direction: column;
    }

    .toolbar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; padding: 0 20px; }

    /* åˆ—è¡¨é¢æ¿å¸ƒå±€è°ƒæ•´ */
    #list-panel {
      display: flex;
      flex-direction: column;
      min-height: 100%;
    }

    /* åˆ—è¡¨é¡¹ */
    .list {
      display: grid;
      gap: 8px;
      flex: 1;
      padding: 0 20px 20px 20px;
    }

    .mail-item {
      padding: 14px 16px; border-radius: 12px; border: 1px solid transparent;
      background: #fff; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .mail-item:hover { border-color: rgba(0,0,0,0.1); transform: translateX(2px); }
    .mail-item.active { border-color: var(--accent); background: #fff8f5; }
    .mail-subject { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
    .mail-meta { font-size: 0.8rem; color: var(--muted); display: flex; justify-content: space-between; gap: 10px; }
    .mail-read input { accent-color: var(--accent); }

    /* === åº•éƒ¨æ‚¬æµ®åˆ†é¡µæ æ ·å¼ === */
    .pagination-bar {
      display: flex;
      justify-content: center; /* å±…ä¸­å¯¹é½ */
      align-items: center;
      gap: 20px;
      padding: 12px 0;
      margin-top: auto; /* ç¡®ä¿ä½äºåº•éƒ¨ */

      /* ç²˜æ€§å®šä½ */
      position: sticky;
      bottom: 0;
      z-index: 10;

      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
    }

    .page-indicator {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      min-width: 60px;
      text-align: center;
    }

    /* è¯¦æƒ…é¡µ */
    .detail-body {
      padding: 20px; border-radius: 12px; background: #fff; border: 1px solid var(--border);
      min-height: 400px; margin-top: 16px;
    }
    .detail-body iframe { border: none; width: 100%; min-height: 600px; }
    .back-btn { padding: 6px 12px; font-size: 0.85rem; border-radius: 8px; }

    /* === å³ä¾§ï¼šAI Agent ä¾§è¾¹æ  (æ‚¬æµ®/åŠé€æ˜é£æ ¼) === */
    .chat-shell {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
      position: relative;
    }

    .chat-header {
      flex-shrink: 0;
      margin-bottom: 12px;
      padding: 12px 16px;
      background: rgba(255,255,255,0.4);
      border-radius: 16px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.3);
    }

    .chat-window {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.65);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.02);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      scroll-behavior: smooth;
    }

    /* èŠå¤©æ°”æ³¡ä¼˜åŒ– */
    .chat-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      max-width: 100%;
      /* å¼ºåˆ¶æ¢è¡Œï¼Œé˜²æ­¢æ’‘å¼€å®¹å™¨ */
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      white-space: pre-wrap;
    }

    .chat-bubble.user {
      background: var(--ink);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: 0 4px 12px rgba(29, 30, 34, 0.15);
    }

    .chat-bubble.agent {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.05);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    }

    .chat-input-area {
      flex-shrink: 0;
      padding: 16px;
      background: rgba(255,255,255,0.9);
      border-top: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 10px;
      backdrop-filter: blur(10px);
    }

    .chat-input-area textarea {
      min-height: 50px;
      max-height: 150px;
      resize: none;
      border: 1px solid rgba(0,0,0,0.1);
      background: #fff;
    }

    /* Agent è®¾ç½®é¢æ¿ (ç»å¯¹å®šä½æ‚¬æµ®) */
    .chat-config-panel {
      position: absolute;
      top: 60px; right: 0; z-index: 100; width: 100%;
      background: rgba(255,255,255,0.95);
      padding: 20px; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      backdrop-filter: blur(12px);
    }

    /* å“åº”å¼ */
    @media (max-width: 1024px) {
      .manager-layout { grid-template-columns: 1fr 320px; }
    }
    @media (max-width: 800px) {
      body { overflow: auto; height: auto; }
      .frame { height: auto; padding-bottom: 40px; }
      #manager-view { display: block; }
      .manager-layout { grid-template-columns: 1fr; height: auto; }
      .chat-shell { height: 600px; margin-top: 24px; }
      .manager-topbar { flex-direction: column; align-items: flex-start; gap: 10px; }
      .manager-topbar .right { width: 100%; justify-content: space-between; }
    }
  </style>
</head>
<body>
<div class="frame">
  <header>
    <div class="eyebrow">MailGenius</div>
    <p class="subtitle" data-i18n="subtitle">è¿æ¥ Gmailï¼Œå¯¼å…¥æ•°æ®ï¼Œä¸ä½ çš„é‚®ä»¶å¯¹è¯ã€‚</p>
    <button id="lang-toggle" class="secondary" style="position: absolute; top: 20px; right: 20px;">EN/ä¸­</button>
  </header>

  <section class="card" id="home-view">
    <div style="display: grid; gap: 20px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div class="status-pill" id="status-pill" data-active="false">
          <span class="status-dot"></span>
          <span id="status-text" data-i18n="checking_auth">æ­£åœ¨æ£€æŸ¥æˆæƒçŠ¶æ€...</span>
        </div>
      </div>

      <div id="home-summary" class="subtitle" style="font-size:1.1rem; color:var(--ink);"></div>

      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button id="login-btn" data-i18n="connect_gmail">è¿æ¥ Gmail</button>
        <button id="enter-btn" class="secondary" data-i18n="enter_manager">è¿›å…¥é‚®ä»¶ç®¡ç†</button>
        <button id="show-import-btn" class="secondary" data-i18n="continue_import">ç»§ç»­å¯¼å…¥é‚®ä»¶</button>
      </div>

      <div id="import-panel" class="hidden" style="margin-top: 10px; padding-top:20px; border-top:1px solid var(--border);">
        <h2 style="font-size:1.2rem; margin:0 0 12px;" data-i18n="import_emails">å¯¼å…¥é‚®ä»¶</h2>
        <form id="range-form" style="display: grid; gap: 12px;">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div><label style="font-size:0.8rem; color:var(--muted)" data-i18n="from">From</label><input id="from-date" type="date" required /></div>
            <div><label style="font-size:0.8rem; color:var(--muted)" data-i18n="to">To</label><input id="to-date" type="date" required /></div>
          </div>
          <button id="sync-btn" type="submit" data-i18n="start_import">å¼€å§‹å¯¼å…¥ï¼ˆå†™å…¥ SQLiteï¼‰</button>
        </form>
        <div class="subtitle" style="margin-top: 10px; font-size:0.8rem;" data-i18n="import_note">
          æ•°æ®å†™å…¥ <code>gmail.sqlite</code>ã€‚é‡å¤æ—¶é—´æ®µä¼šè‡ªåŠ¨å»é‡ã€‚
        </div>
      </div>

      <div style="background:rgba(0,0,0,0.03); padding:12px; border-radius:10px;">
        <strong style="font-size:0.8rem; color:var(--muted); display:block; margin-bottom:4px;" data-i18n="system_log">ç³»ç»Ÿæ—¥å¿—</strong>
        <div id="log" class="subtitle" style="font-size:0.9rem;" data-i18n="waiting">ç­‰å¾…æ“ä½œã€‚</div>
      </div>
    </div>
  </section>

  <section id="manager-view" class="hidden">
    <div class="manager-topbar">
      <div class="left" style="display:flex; align-items:center; gap:12px;">
        <button id="back-home-btn" class="secondary" type="button" style="padding:6px 12px;" data-i18n="home">â† é¦–é¡µ</button>
        <div class="status-pill" id="manager-pill" data-active="true">
          <span class="status-dot"></span>
          <span id="manager-email" data-i18n="not_connected">æœªè¿æ¥</span>
        </div>
        <span class="subtitle" id="manager-count" style="font-size:0.85rem"></span>
      </div>

      <div class="right" style="display:flex; align-items:center; gap:8px;">
        <div class="sync-widget" title="è‡ªåŠ¨åå°æ‹‰å–æ–°é‚®ä»¶">
          <label>
            <input id="auto-sync-toggle" type="checkbox" style="accent-color: var(--accent); width:auto;" />
            <span data-i18n="auto_sync">è‡ªåŠ¨åŒæ­¥</span>
          </label>
          <div id="auto-sync-options" style="display:flex; align-items:center; gap:4px; border-left:1px solid var(--border); padding-left:8px; margin-left:4px;">
            <input id="auto-sync-interval" type="number" min="1" step="1" value="30" />
            <span style="font-size:0.8rem; color:var(--muted)" data-i18n="min">åˆ†é’Ÿ</span>
          </div>
        </div>

        <button id="import-more-btn" class="secondary" type="button" style="padding:8px 14px;" data-i18n="import">å¯¼å…¥</button>
        <button id="refresh-list-btn" class="secondary" type="button" style="padding:8px 14px;" data-i18n="refresh">åˆ·æ–°</button>
      </div>
    </div>

    <div class="manager-layout">

      <div class="mail-section">
        <div class="mail-content-wrapper">

          <div class="toolbar" style="border-bottom:1px solid var(--border); padding-bottom:12px; margin-bottom:16px; margin-top:20px;">
            <button id="tab-inbox" class="secondary" data-i18n="inbox">æ”¶ä»¶ç®±</button>
            <button id="tab-sent" class="secondary" data-i18n="sent">å·²å‘é€</button>
            <button id="tab-compose" class="secondary" data-i18n="compose">å†™é‚®ä»¶</button>
          </div>

          <div id="list-panel">
            <div class="toolbar" id="inbox-toolbar">
              <select id="order-select" style="width:auto;">
                <option value="desc" data-i18n="time_desc">æ—¶é—´ï¼šå€’åº</option>
                <option value="asc" data-i18n="time_asc">æ—¶é—´ï¼šæ­£åº</option>
              </select>
              <select id="read-filter" style="width:auto;">
                <option value="all" data-i18n="all_read">å…¨éƒ¨</option>
                <option value="unread" data-i18n="unread_filter">æœªè¯»</option>
                <option value="read" data-i18n="read_filter">å·²è¯»</option>
              </select>
              <select id="priority-filter" style="width:auto;">
                <option value="all" data-i18n="all_priority">å…¨éƒ¨ä¼˜å…ˆçº§</option>
                <option value="2" data-i18n="high_priority_opt">ğŸ”´ é«˜ä¼˜å…ˆçº§</option>
                <option value="1" data-i18n="low_priority_opt">âšª ä½ä¼˜å…ˆçº§</option>
                <option value="0" data-i18n="not_analyzed_opt">ğŸ¤” æœªåˆ†æ</option>
              </select>
              <button id="load-btn" class="secondary" type="button" data-i18n="load">åŠ è½½</button>
            </div>

            <!-- Search toolbar temporarily hidden - feature not yet implemented -->
            <div class="toolbar hidden" id="search-toolbar" style="gap:10px; flex-wrap:wrap; align-items:flex-end;">
              <div style="display:grid; gap:6px;">
                <label class="footer" data-i18n="sender">å‘ä»¶äºº</label>
                <input id="search-from" type="text" data-i18n-placeholder="search_ph_sender" placeholder="sender@example.com" />
              </div>
              <div style="display:grid; gap:6px;">
                <label class="footer" data-i18n="subject">ä¸»é¢˜</label>
                <input id="search-subject" type="text" data-i18n-placeholder="search_ph_subject" placeholder="å…³é”®è¯" />
              </div>
              <button id="search-btn" class="secondary" type="button" data-i18n="search">æœç´¢</button>
            </div>

            <div class="toolbar hidden" id="sent-toolbar">
              <input type="date" id="sent-from" style="width:auto;" />
              <span style="color:var(--muted)">-</span>
              <input type="date" id="sent-to" style="width:auto;" />
              <button id="sent-refresh" class="secondary" type="button" data-i18n="refresh">åˆ·æ–°</button>
            </div>

            <div id="mail-list" class="list"></div>

            <div id="pagination-toolbar" class="pagination-bar">
              <button id="page-prev" class="secondary" type="button" data-i18n="prev_page">â† ä¸Šä¸€é¡µ</button>
              <div id="page-indicator" class="page-indicator">ç¬¬ 1 é¡µ</div>
              <button id="page-next" class="secondary" type="button" data-i18n="next_page">ä¸‹ä¸€é¡µ â†’</button>
            </div>
          </div>

          <div id="detail-panel" class="hidden" style="padding: 0 20px 20px 20px;">
            <div class="back-row" style="display: flex; justify-content: space-between; margin-bottom: 16px; align-items:center;">
              <button id="back-list-btn" class="back-btn secondary" type="button" data-i18n="back_list">â† è¿”å›åˆ—è¡¨</button>
              <button id="reply-btn" class="secondary" type="button" disabled data-i18n="reply">å›å¤</button>
            </div>
            <h2 id="detail-subject" style="margin: 0 0 10px;" data-i18n="select_mail">é€‰æ‹©ä¸€å°é‚®ä»¶</h2>
            <div class="mail-meta" id="detail-meta" style="margin-bottom: 20px;"></div>
            <div id="detail-body" class="detail-body" data-i18n="no_mail_selected">æœªé€‰æ‹©é‚®ä»¶ã€‚</div>
          </div>

          <div id="compose-panel" class="hidden" style="padding: 0 20px 20px 20px;">
            <h3 style="margin-top:0;" data-i18n="compose">å†™é‚®ä»¶</h3>
            <form id="compose-form" class="range" style="display:grid; gap:15px;">
              <div>
                <label style="font-size:0.8rem;color:var(--muted)" data-i18n="drafts">è‰ç¨¿ç®±</label>
                <div style="display:flex; gap:10px;">
                  <select id="draft-select" style="flex:1;">
                    <option value="" data-i18n="draft_select_default">é€‰æ‹©è‰ç¨¿ï¼ˆæŒ‰ä¸»é¢˜ï¼‰</option>
                  </select>
                  <button id="draft-refresh" class="secondary" type="button" data-i18n="refresh_drafts">åˆ·æ–°</button>
                </div>
              </div>
              <div><label style="font-size:0.8rem;color:var(--muted)" data-i18n="to">æ”¶ä»¶äºº</label><input id="compose-to" type="email" required /></div>
              <div><label style="font-size:0.8rem;color:var(--muted)" data-i18n="subject">ä¸»é¢˜</label><input id="compose-subject" type="text" required /></div>
              <div><textarea id="compose-body" style="min-height: 250px;" data-i18n-placeholder="compose_ph" placeholder="æ­£æ–‡å†…å®¹..."></textarea></div>
              <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button id="draft-save" class="secondary" type="button" data-i18n="save_draft">ä¿å­˜è‰ç¨¿</button>
                <button id="compose-send" type="submit" data-i18n="send_email">å‘é€é‚®ä»¶</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <section class="chat-shell">
        <div class="chat-header">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h2 style="margin:0; font-size:1.1rem;">Agent</h2>
            <button id="agent-config-toggle" class="secondary" type="button" style="padding:4px 10px; font-size:0.8rem;" data-i18n="agent_settings">âš™ è®¾ç½®</button>
          </div>
          <div class="chat-session-controls" style="display:flex; gap:8px;">
            <select id="agent-session-select" style="font-size:0.85rem; padding:6px; flex:1;"></select>
            <button id="agent-new-session" class="secondary" type="button" style="padding:6px 10px;">+</button>
          </div>
          <div class="footer" id="agent-status" style="margin-top:6px; font-size:0.75rem; color:var(--muted);" data-i18n="agent_not_configured">æœªé…ç½®</div>
        </div>

        <div id="agent-config-panel" class="chat-config-panel hidden">
          <h4 style="margin:0 0 12px;" data-i18n="llm_config">LLM é…ç½®</h4>
          <div style="display:grid; gap:12px;">
            <input id="agent-api-key" type="password" data-i18n-placeholder="agent_ph_key" placeholder="API Key" />
            <input id="agent-base-url" type="text" data-i18n-placeholder="agent_ph_url" placeholder="Base URL (å¯é€‰)" />
            <input id="agent-model" type="text" data-i18n-placeholder="agent_ph_model" placeholder="Model (e.g. gemini-3)" />
            <input id="agent-primary-email" type="email" data-i18n-placeholder="agent_ph_email" placeholder="ä¸»è¦é‚®ç®± (ä¾‹å¦‚: you@example.com)" />
            <textarea id="agent-system-prompt" data-i18n-placeholder="agent_ph_prompt" placeholder="System Prompt (ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ª...åŠ©æ‰‹)"></textarea>
            <button id="agent-save-btn" type="button" data-i18n="save_config">ä¿å­˜é…ç½®</button>
          </div>
        </div>

        <div class="chat-window">
          <div id="agent-messages" class="chat-messages"></div>

          <div class="chat-input-area">
            <div class="footer" id="agent-hint" style="font-size:0.75rem; color:var(--muted);" data-i18n="ready_hint">å‡†å¤‡å°±ç»ªã€‚</div>
            <textarea id="chat-text" data-i18n-placeholder="chat_ph" placeholder="è¾“å…¥æŒ‡ä»¤ (Ctrl+Enter å‘é€)..." onkeydown="if(event.ctrlKey && event.keyCode==13){document.getElementById('chat-send').click();}"></textarea>
            <div style="text-align:right;">
              <button id="chat-send" type="button" style="padding:8px 24px;" data-i18n="send">å‘é€</button>
            </div>
          </div>
        </div>
      </section>

    </div>
  </section>
</div>

<script>
  const translations = {
    zh: {
      app_title: 'MailGenius',
      subtitle: 'è¿æ¥ Gmailï¼Œå¯¼å…¥æ•°æ®ï¼Œä¸ä½ çš„é‚®ä»¶å¯¹è¯ã€‚',
      checking_auth: 'æ­£åœ¨æ£€æŸ¥æˆæƒçŠ¶æ€...',
      authorized: 'å·²æˆæƒ',
      not_connected: 'æœªè¿æ¥',
      connected_email: 'å·²è¿æ¥ï¼š{email}',
      connected_default: 'å·²è¿æ¥',
      connect_prompt: 'è¯·å…ˆè¿æ¥ Gmailï¼ˆOAuth æˆæƒï¼‰ã€‚',
      imported_summary: 'å·²ä¸º {email} å¯¼å…¥ {importedCount} å°é‚®ä»¶',
      imported_count: 'å·²å¯¼å…¥ï¼š{importedCount} å°',
      status_check_fail: 'çŠ¶æ€æ£€æŸ¥å¤±è´¥',
      importing: 'æ­£åœ¨å¯¼å…¥...',
      skipped_import: 'å·²è·³è¿‡ï¼šè¯¥èŒƒå›´ä¹‹å‰å¯¼å…¥è¿‡ï¼ˆ{email}ï¼Œ{from} ~ {to}ï¼‰ã€‚å·²å¯¼å…¥æ€»æ•°ï¼š{importedCount}',
      import_complete: 'å¯¼å…¥å®Œæˆï¼šä¸º {email} å¤„ç† {processed} å°é‚®ä»¶ï¼ˆ{from} ~ {to}ï¼‰ã€‚å·²å¯¼å…¥æ€»æ•°ï¼š{importedCount}',
      error_prefix: 'é”™è¯¯ï¼š{msg}',
      fill_required: 'è¯·å¡«å†™æ”¶ä»¶äººå’Œä¸»é¢˜',
      sending: 'æ­£åœ¨å‘é€...',
      send_success: 'å‘é€æˆåŠŸ',
      send_fail: 'å‘é€å¤±è´¥ï¼š{msg}',
      draft_saved: 'è‰ç¨¿å·²ä¿å­˜ã€‚',
      fill_required_draft: 'è¯·å¡«å†™æ”¶ä»¶äººå’Œä¸»é¢˜åå†ä¿å­˜è‰ç¨¿ã€‚',
      reply_prefix: 'Re: ',
      original_mail: '\n\n--- åŸé‚®ä»¶ ---\n',
      agent_configured: 'å·²é…ç½®',
      agent_not_configured: 'æœªé…ç½®',
      agent_ready: 'å¯ä»¥å¼€å§‹å¯¹è¯ã€‚',
      agent_need_config: 'è¯·å…ˆé…ç½® LLM API Keyã€‚',
      config_load_fail: 'é…ç½®åŠ è½½å¤±è´¥',
      config_save_fail: 'ä¿å­˜å¤±è´¥',
      search_loading: 'æœç´¢ä¸­...',
      search_no_criteria: 'è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæœç´¢æ¡ä»¶ã€‚',
      loading: 'åŠ è½½ä¸­...',
      page_num: 'ç¬¬ {page} é¡µ',
      no_mail: 'æ²¡æœ‰é‚®ä»¶ï¼ˆæˆ–å°šæœªå¯¼å…¥ï¼‰ã€‚',
      no_subject: '(æ— ä¸»é¢˜)',
      unknown_sender: 'æœªçŸ¥å‘ä»¶äºº',
      unknown_date: 'æœªçŸ¥æ—¥æœŸ',
      read: 'å·²è¯»',
      unread: 'æœªè¯»',
      high_priority: 'ğŸ”´ é«˜',
      low_priority: 'âšª ä½',
      not_analyzed: 'ğŸ¤” æœªåˆ†æ',
      select_mail: 'é€‰æ‹©ä¸€å°é‚®ä»¶',
      no_mail_selected: 'æœªé€‰æ‹©é‚®ä»¶ã€‚',
      draft_select_default: 'é€‰æ‹©è‰ç¨¿ï¼ˆæŒ‰ä¸»é¢˜ï¼‰',
      draft_load_fail: 'è‰ç¨¿åŠ è½½å¤±è´¥',
      connect_gmail: 'è¿æ¥ Gmail',
      enter_manager: 'è¿›å…¥é‚®ä»¶ç®¡ç†',
      continue_import: 'ç»§ç»­å¯¼å…¥é‚®ä»¶',
      import_emails: 'å¯¼å…¥é‚®ä»¶',
      from: 'From',
      to: 'To',
      start_import: 'å¼€å§‹å¯¼å…¥ï¼ˆå†™å…¥ SQLiteï¼‰',
      import_note: 'æ•°æ®å†™å…¥ <code>gmail.sqlite</code>ã€‚é‡å¤æ—¶é—´æ®µä¼šè‡ªåŠ¨å»é‡ã€‚',
      system_log: 'ç³»ç»Ÿæ—¥å¿—',
      waiting: 'ç­‰å¾…æ“ä½œã€‚',
      home: 'â† é¦–é¡µ',
      auto_sync: 'è‡ªåŠ¨åŒæ­¥',
      min: 'åˆ†é’Ÿ',
      import: 'å¯¼å…¥',
      refresh: 'åˆ·æ–°',
      inbox: 'æ”¶ä»¶ç®±',
      sent: 'å·²å‘é€',
      compose: 'å†™é‚®ä»¶',
      time_desc: 'æ—¶é—´ï¼šå€’åº',
      time_asc: 'æ—¶é—´ï¼šæ­£åº',
      all_read: 'å…¨éƒ¨',
      unread_filter: 'æœªè¯»',
      read_filter: 'å·²è¯»',
      all_priority: 'å…¨éƒ¨ä¼˜å…ˆçº§',
      high_priority_opt: 'ğŸ”´ é«˜ä¼˜å…ˆçº§',
      low_priority_opt: 'âšª ä½ä¼˜å…ˆçº§',
      not_analyzed_opt: 'ğŸ¤” æœªåˆ†æ',
      load: 'åŠ è½½',
      sender: 'å‘ä»¶äºº',
      subject: 'ä¸»é¢˜',
      search: 'æœç´¢',
      prev_page: 'â† ä¸Šä¸€é¡µ',
      next_page: 'ä¸‹ä¸€é¡µ â†’',
      back_list: 'â† è¿”å›åˆ—è¡¨',
      reply: 'å›å¤',
      drafts: 'è‰ç¨¿ç®±',
      refresh_drafts: 'åˆ·æ–°',
      save_draft: 'ä¿å­˜è‰ç¨¿',
      send_email: 'å‘é€é‚®ä»¶',
      agent_settings: 'âš™ è®¾ç½®',
      llm_config: 'LLM é…ç½®',
      save_config: 'ä¿å­˜é…ç½®',
      ready_hint: 'å‡†å¤‡å°±ç»ªã€‚',
      send: 'å‘é€',
      search_ph_sender: 'sender@example.com',
      search_ph_subject: 'å…³é”®è¯',
      compose_ph: 'æ­£æ–‡å†…å®¹...',
      agent_ph_key: 'API Key',
      agent_ph_url: 'Base URL (å¯é€‰)',
      agent_ph_model: 'Model (e.g. gemini-3)',
      agent_ph_email: 'ä¸»è¦é‚®ç®± (ä¾‹å¦‚: you@example.com)',
      agent_ph_prompt: 'System Prompt (ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ª...åŠ©æ‰‹)',
      chat_ph: 'è¾“å…¥æŒ‡ä»¤ (Ctrl+Enter å‘é€)...',
      hint_mcp_approve: 'MCP ä¾èµ–éœ€è¦æ‰§è¡Œ `deno approve-scripts`ï¼Œæˆ–æ”¹ç”¨ Node + tsx å¯åŠ¨ MCPã€‚',
      hint_mcp_connect_fail: 'MCP æœªèƒ½å¯åŠ¨ã€‚è¯·ç¡®è®¤ `npm install` å·²å®Œæˆä¸” `gmail.sqlite` å­˜åœ¨ã€‚',
      hint_install_deps: 'æœ¬åœ°ä¾èµ–å¯èƒ½æœªå®‰è£…å®Œæˆï¼Œè¯·å…ˆè¿è¡Œ `npm install`ã€‚'
    },
    en: {
      app_title: 'MailGenius',
      subtitle: 'Connect Gmail, import data, chat with your emails.',
      checking_auth: 'Checking authorization status...',
      authorized: 'Authorized',
      not_connected: 'Not Connected',
      connected_email: 'Connected: {email}',
      connected_default: 'Connected',
      connect_prompt: 'Please connect Gmail (OAuth).',
      imported_summary: 'Imported {importedCount} emails for {email}',
      imported_count: 'Imported: {importedCount}',
      status_check_fail: 'Status check failed',
      importing: 'Importing...',
      skipped_import: 'Skipped: Range already imported ({email}, {from} ~ {to}). Total: {importedCount}',
      import_complete: 'Import complete: Processed {processed} emails for {email} ({from} ~ {to}). Total: {importedCount}',
      error_prefix: 'Error: {msg}',
      fill_required: 'Please fill in recipient and subject',
      sending: 'Sending...',
      send_success: 'Sent successfully',
      send_fail: 'Send failed: {msg}',
      draft_saved: 'Draft saved.',
      fill_required_draft: 'Please fill in recipient and subject before saving.',
      reply_prefix: 'Re: ',
      original_mail: '\n\n--- Original Message ---\n',
      agent_configured: 'Configured',
      agent_not_configured: 'Not Configured',
      agent_ready: 'Ready to chat.',
      agent_need_config: 'Please configure LLM API Key first.',
      config_load_fail: 'Failed to load config',
      config_save_fail: 'Save failed',
      search_loading: 'Searching...',
      search_no_criteria: 'Please enter at least one search criteria.',
      loading: 'Loading...',
      page_num: 'Page {page}',
      no_mail: 'No emails (or not imported yet).',
      no_subject: '(No Subject)',
      unknown_sender: 'Unknown Sender',
      unknown_date: 'Unknown Date',
      read: 'Read',
      unread: 'Unread',
      high_priority: 'ğŸ”´ High',
      low_priority: 'âšª Low',
      not_analyzed: 'ğŸ¤” N/A',
      select_mail: 'Select an email',
      no_mail_selected: 'No email selected.',
      draft_select_default: 'Select Draft (by subject)',
      draft_load_fail: 'Failed to load drafts',
      connect_gmail: 'Connect Gmail',
      enter_manager: 'Enter Mail Manager',
      continue_import: 'Continue Importing',
      import_emails: 'Import Emails',
      from: 'From',
      to: 'To',
      start_import: 'Start Import (Write to SQLite)',
      import_note: 'Data written to <code>gmail.sqlite</code>. Duplicates removed.',
      system_log: 'System Log',
      waiting: 'Waiting for operation.',
      home: 'â† Home',
      auto_sync: 'Auto Sync',
      min: 'min',
      import: 'Import',
      refresh: 'Refresh',
      inbox: 'Inbox',
      sent: 'Sent',
      compose: 'Compose',
      time_desc: 'Time: Desc',
      time_asc: 'Time: Asc',
      all_read: 'All',
      unread_filter: 'Unread',
      read_filter: 'Read',
      all_priority: 'All Priorities',
      high_priority_opt: 'ğŸ”´ High Priority',
      low_priority_opt: 'âšª Low Priority',
      not_analyzed_opt: 'ğŸ¤” Not Analyzed',
      load: 'Load',
      sender: 'Sender',
      subject: 'Subject',
      search: 'Search',
      prev_page: 'â† Prev',
      next_page: 'Next â†’',
      back_list: 'â† Back to List',
      reply: 'Reply',
      drafts: 'Drafts',
      refresh_drafts: 'Refresh',
      save_draft: 'Save Draft',
      send_email: 'Send Email',
      agent_settings: 'âš™ Settings',
      llm_config: 'LLM Config',
      save_config: 'Save Config',
      ready_hint: 'Ready.',
      send: 'Send',
      search_ph_sender: 'sender@example.com',
      search_ph_subject: 'Keywords',
      compose_ph: 'Body content...',
      agent_ph_key: 'API Key',
      agent_ph_url: 'Base URL (Optional)',
      agent_ph_model: 'Model (e.g. gemini-3)',
      agent_ph_email: 'Primary Email (e.g. you@example.com)',
      agent_ph_prompt: 'System Prompt (e.g. You are a helper...)',
      chat_ph: 'Enter command (Ctrl+Enter to send)...',
      hint_mcp_approve: 'MCP dependencies require `deno approve-scripts`, or use Node + tsx to start MCP.',
      hint_mcp_connect_fail: 'MCP failed to start. Please ensure `npm install` is completed and `gmail.sqlite` exists.',
      hint_install_deps: 'Local dependencies may not be installed. Please run `npm install`.'
    }
  };

  let currentLang = 'zh';
  let currentEmail = null;

  function t(key, params = {}) {
    let str = translations[currentLang][key] || key;
    for (const [k, v] of Object.entries(params)) {
      str = str.replace('{' + k + '}', v);
    }
    return str;
  }

  function updatePageLanguage() {
    document.title = t('app_title');
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.dataset.i18n;
      if (translations[currentLang][key]) {
        if (key === 'import_note') el.innerHTML = translations[currentLang][key];
        else el.textContent = translations[currentLang][key];
      }
    });
    document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
      const key = el.dataset.i18nPlaceholder;
      if (translations[currentLang][key]) {
        el.placeholder = translations[currentLang][key];
      }
    });

    if (cachedProfile) {
      homeSummary.textContent = t('imported_summary', {email: cachedProfile.email, importedCount: cachedProfile.importedCount});
      managerCount.textContent = t('imported_count', {importedCount: cachedProfile.importedCount});
    } else {
      const isAuthorized = statusPill.dataset.active === 'true';
      if (isAuthorized) {
        homeSummary.textContent = currentEmail ? t('connected_email', {email: currentEmail}) : t('connected_default');
      } else {
        homeSummary.textContent = t('connect_prompt');
      }
    }

    // Update status text based on current state
    const isAuthorized = statusPill.dataset.active === 'true';
    statusText.textContent = isAuthorized ? t('authorized') : (statusText.textContent === t('checking_auth') ? t('checking_auth') : t('not_connected'));

    if (currentView === 'sent') {
      pageIndicator.textContent = t('page_num', {page: sentPage});
    } else {
      pageIndicator.textContent = t('page_num', {page: inboxPage});
    }
  }

  document.getElementById('lang-toggle').addEventListener('click', () => {
    currentLang = currentLang === 'zh' ? 'en' : 'zh';
    updatePageLanguage();
    // Refresh list to update dynamic content like dates or priorities if we were to translate them deeply
    // For now, just re-rendering the list if it's there
    if (!listPanel.classList.contains('hidden')) {
      loadActiveList();
    }
  });

  const homeView = document.getElementById('home-view')
  const managerView = document.getElementById('manager-view')

  const statusText = document.getElementById('status-text')
  const statusPill = document.getElementById('status-pill')
  const homeSummary = document.getElementById('home-summary')

  const loginBtn = document.getElementById('login-btn')
  const enterBtn = document.getElementById('enter-btn')
  const showImportBtn = document.getElementById('show-import-btn')
  const importPanel = document.getElementById('import-panel')

  // Auto Sync Elements
  const autoSyncToggle = document.getElementById('auto-sync-toggle')
  const autoSyncInterval = document.getElementById('auto-sync-interval')
  const autoSyncOptionsDiv = document.getElementById('auto-sync-options')

  const syncBtn = document.getElementById('sync-btn')
  const fromInput = document.getElementById('from-date')
  const toInput = document.getElementById('to-date')
  const log = document.getElementById('log')

  const backHomeBtn = document.getElementById('back-home-btn')
  const importMoreBtn = document.getElementById('import-more-btn')
  const refreshListBtn = document.getElementById('refresh-list-btn')
  const managerEmail = document.getElementById('manager-email')
  const managerCount = document.getElementById('manager-count')

  const listPanel = document.getElementById('list-panel')
  const detailPanel = document.getElementById('detail-panel')
  const backListBtn = document.getElementById('back-list-btn')
  const mailList = document.getElementById('mail-list')
  const pagePrev = document.getElementById('page-prev')
  const pageNext = document.getElementById('page-next')
  const pageIndicator = document.getElementById('page-indicator')
  const searchFrom = document.getElementById('search-from')
  const searchSubject = document.getElementById('search-subject')
  const searchThread = document.getElementById('search-thread')
  const searchMessage = document.getElementById('search-message')
  const searchBtn = document.getElementById('search-btn')
  const detailSubject = document.getElementById('detail-subject')
  const detailMeta = document.getElementById('detail-meta')
  const detailBody = document.getElementById('detail-body')
  const replyBtn = document.getElementById('reply-btn')
  const orderSelect = document.getElementById('order-select')
  const readFilter = document.getElementById('read-filter')
  const priorityFilter = document.getElementById('priority-filter')
  const loadBtn = document.getElementById('load-btn')
  const tabInbox = document.getElementById('tab-inbox')
  const tabSent = document.getElementById('tab-sent')
  const tabCompose = document.getElementById('tab-compose')
  const inboxToolbar = document.getElementById('inbox-toolbar')
  const sentToolbar = document.getElementById('sent-toolbar')
  const sentFromInput = document.getElementById('sent-from')
  const sentToInput = document.getElementById('sent-to')
  const sentRefreshBtn = document.getElementById('sent-refresh')
  const composePanel = document.getElementById('compose-panel')
  const composeForm = document.getElementById('compose-form')
  const composeTo = document.getElementById('compose-to')
  const composeSubject = document.getElementById('compose-subject')
  const composeBody = document.getElementById('compose-body')
  const draftSelect = document.getElementById('draft-select')
  const draftRefreshBtn = document.getElementById('draft-refresh')
  const draftSaveBtn = document.getElementById('draft-save')
  const agentStatus = document.getElementById('agent-status')
  const agentConfigToggle = document.getElementById('agent-config-toggle')
  const agentConfigPanel = document.getElementById('agent-config-panel')
  const agentApiKey = document.getElementById('agent-api-key')
  const agentBaseUrl = document.getElementById('agent-base-url')
  const agentModel = document.getElementById('agent-model')
  const agentPrimaryEmail = document.getElementById('agent-primary-email')
  const agentSystemPrompt = document.getElementById('agent-system-prompt')
  const agentSaveBtn = document.getElementById('agent-save-btn')
  const agentNewSessionBtn = document.getElementById('agent-new-session')
  const agentSessionSelect = document.getElementById('agent-session-select')
  const agentMessages = document.getElementById('agent-messages')
  const agentHint = document.getElementById('agent-hint')
  const chatText = document.getElementById('chat-text')
  const chatSend = document.getElementById('chat-send')

  let activeId = null
  let cachedProfile = null
  let loadingList = false
  let currentView = 'inbox'
  let currentMessage = null
  let inboxOffset = 0
  let inboxPage = 1
  const inboxLimit = 50
  let sentPage = 1
  let sentPageTokens = [null]
  let sentHasNext = false
  let currentDraftId = null
  let currentAgentSessionId = localStorage.getItem('agentSessionId')

  const formatDate = (date) => date.toISOString().slice(0, 10)
  const setDefaultRange = () => {
    const today = new Date()
    const utcToday = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()))
    const from = new Date(utcToday)
    from.setUTCDate(from.getUTCDate() - 6)
    fromInput.value = formatDate(from)
    toInput.value = formatDate(utcToday)
  }

  const setDefaultSentRange = () => {
    const today = new Date()
    const utcToday = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()))
    const from = new Date(utcToday)
    from.setUTCDate(from.getUTCDate() - 29)
    if (sentFromInput) sentFromInput.value = formatDate(from)
    if (sentToInput) sentToInput.value = formatDate(utcToday)
  }

  // === UI Helper for Auto Sync ===
  const updateSyncUI = (enabled) => {
    // å¯ç”¨/ç¦ç”¨è¾“å…¥æ¡†ï¼Œå¹¶è®¾ç½®æ ·å¼
    autoSyncInterval.disabled = !enabled
    if (autoSyncOptionsDiv) {
      autoSyncOptionsDiv.style.opacity = enabled ? '1' : '0.4'
      autoSyncOptionsDiv.style.pointerEvents = enabled ? 'auto' : 'none'
    }
  }

  const loadAutoSyncConfig = async () => {
    try {
      const data = await fetchJson('/api/auto-sync')
      const enabled = Boolean(data.enabled)
      autoSyncToggle.checked = enabled
      autoSyncInterval.value = String(data.intervalMinutes || 30)
      updateSyncUI(enabled)
    } catch (err) {
      autoSyncToggle.checked = false
      autoSyncInterval.value = '30'
      updateSyncUI(false)
    }
  }

  const saveAutoSyncConfig = async () => {
    const enabled = autoSyncToggle.checked
    const rawInterval = Number(autoSyncInterval.value)
    // é™åˆ¶æœ€å°å€¼ä¸º 1 åˆ†é’Ÿ
    const intervalMinutes = Math.max(1, rawInterval || 30)

    // å¦‚æœç”¨æˆ·è¾“å…¥äº†éæ³•å€¼ï¼Œé‡ç½®å› UI
    if (rawInterval !== intervalMinutes) {
      autoSyncInterval.value = intervalMinutes
    }

    updateSyncUI(enabled) // ç«‹å³æ›´æ–° UI çŠ¶æ€

    try {
      const data = await fetchJson('/api/auto-sync', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled, intervalMinutes }),
      })
      console.log(`Auto sync saved: ${data.enabled}, ${data.intervalMinutes}m`)
    } catch (err) {
      console.error(`ä¿å­˜åŒæ­¥è®¾ç½®å¤±è´¥: ${err.message}`)
      // å‡ºé”™å›æ»šçŠ¶æ€
      autoSyncToggle.checked = !enabled
      updateSyncUI(!enabled)
    }
  }

  const ensureDraftsLoaded = async () => {
    if (draftSelect.options.length <= 1) {
      await loadDrafts()
    }
  }

  const loadDrafts = async () => {
    try {
      const data = await fetchJson('/api/drafts')
      draftSelect.innerHTML = '<option value="">' + t('draft_select_default') + '</option>'
      data.drafts.forEach((draft) => {
        const option = document.createElement('option')
        option.value = draft.id
        option.textContent = draft.subject || t('no_subject')
        draftSelect.appendChild(option)
      })
    } catch (err) {
      draftSelect.innerHTML = '<option value="">' + t('draft_load_fail') + '</option>'
    }
  }

  const loadDraft = async (id) => {
    const data = await fetchJson(`/api/drafts/${id}`)
    const draft = data.draft
    currentDraftId = draft.id
    composeTo.value = draft.to_email || ''
    composeSubject.value = draft.subject || ''
    composeBody.value = draft.text || ''
    await fetchJson(`/api/drafts/${id}`, { method: 'DELETE' })
    await loadDrafts()
  }

  const setStatus = (authorized, email) => {
    statusPill.dataset.active = authorized ? 'true' : 'false'
    statusText.textContent = authorized ? t('authorized') : t('not_connected')
    loginBtn.disabled = authorized
    enterBtn.disabled = !authorized
    showImportBtn.disabled = !authorized
    syncBtn.disabled = !authorized
    currentEmail = email;
    if (authorized) {
      homeSummary.textContent = email ? t('connected_email', {email}) : t('connected_default')
    } else {
      homeSummary.textContent = t('connect_prompt')
    }
  }

  const showHome = () => {
    homeView.classList.remove('hidden')
    managerView.classList.add('hidden')
  }

  const showManager = () => {
    homeView.classList.add('hidden')
    managerView.classList.remove('hidden')
    ensureDraftsLoaded()
  }

  const showList = () => {
    listPanel.classList.remove('hidden')
    detailPanel.classList.add('hidden')
  }

  const showDetail = () => {
    listPanel.classList.add('hidden')
    detailPanel.classList.remove('hidden')
  }
  const disableReply = () => {
    currentMessage = null
    replyBtn.disabled = true
  }

  const switchView = (view) => {
    currentView = view
    tabInbox.classList.toggle('secondary', view !== 'inbox')
    tabSent.classList.toggle('secondary', view !== 'sent')
    tabCompose.classList.toggle('secondary', view !== 'compose')
    inboxToolbar.classList.toggle('hidden', view !== 'inbox')
    sentToolbar.classList.toggle('hidden', view !== 'sent')
    composePanel.classList.toggle('hidden', view !== 'compose')
    listPanel.classList.toggle('hidden', view === 'compose')
    detailPanel.classList.add('hidden')
    if (view === 'inbox' || view === 'sent') {
      showList()
      loadActiveList()
    }
  }

  async function fetchJson(url, opts = {}) {
    const res = await fetch(url, { cache: 'no-store', ...opts })
    if (!res.ok) {
      const text = await res.text()
      throw new Error(text || `è¯·æ±‚å¤±è´¥ï¼š${res.status}`)
    }
    return res.json()
  }

  const refreshProfile = async () => {
    statusText.textContent = t('checking_auth')
    try {
      const data = await fetchJson('/api/profile')
      if (!data.authorized) {
        const status = await fetchJson('/api/status')
        cachedProfile = null
        setStatus(Boolean(status.authorized), status.email || null)
        return
      }
      cachedProfile = data
      setStatus(true, data.email)
      homeSummary.textContent = t('imported_summary', {email: data.email, importedCount: data.importedCount})
      managerEmail.textContent = data.email
      managerCount.textContent = t('imported_count', {importedCount: data.importedCount})
      if (!homeView.classList.contains('hidden')) {
        showManager()
        showList()
      }
      await loadList()
    } catch (err) {
      statusText.textContent = t('status_check_fail')
    }
  }

  loginBtn.addEventListener('click', () => {
    window.location.href = '/auth/start'
  })

  enterBtn.addEventListener('click', async () => {
    await refreshProfile()
    showManager()
    showList()
    await loadList()
  })

  showImportBtn.addEventListener('click', () => {
    importPanel.classList.toggle('hidden')
  })

  // Auto Sync Listeners (Modified)
  autoSyncToggle.addEventListener('change', () => {
    saveAutoSyncConfig()
  })

  // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
  autoSyncInterval.addEventListener('blur', saveAutoSyncConfig)
  // å›è½¦æ—¶è§¦å‘å¤±å»ç„¦ç‚¹ï¼ˆè¿›è€Œä¿å­˜ï¼‰
  autoSyncInterval.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      autoSyncInterval.blur()
    }
  })

  backHomeBtn.addEventListener('click', () => {
    showHome()
  })

  importMoreBtn.addEventListener('click', () => {
    showHome()
    importPanel.classList.remove('hidden')
    window.scrollTo({ top: 0, behavior: 'smooth' })
  })

  refreshListBtn.addEventListener('click', async () => {
    await refreshProfile()
    await loadActiveList()
  })

  tabInbox.addEventListener('click', () => {
    showManager()
    switchView('inbox')
  })

  tabSent.addEventListener('click', () => {
    showManager()
    switchView('sent')
  })

  tabCompose.addEventListener('click', () => {
    showManager()
    switchView('compose')
  })

  loadBtn.addEventListener('click', loadList)
  orderSelect.addEventListener('change', loadList)
  readFilter.addEventListener('change', loadList)
  priorityFilter.addEventListener('change', loadList)
  sentRefreshBtn.addEventListener('click', loadSent)

  backListBtn.addEventListener('click', () => {
    showList()
  })

  document.getElementById('range-form').addEventListener('submit', async (event) => {
    event.preventDefault()
    const from = fromInput.value
    const to = toInput.value
    if (!from || !to) return
    syncBtn.disabled = true
    log.textContent = t('importing')
    try {
      const params = new URLSearchParams({ from, to, t: Date.now().toString() })
      const data = await fetchJson(`/api/sync?${params.toString()}`)
      if (data.skipped) {
        log.textContent = t('skipped_import', {email: data.email, from: data.from, to: data.to, importedCount: data.importedCount})
      } else {
        log.textContent = t('import_complete', {email: data.email, processed: data.processed, from: data.from, to: data.to, importedCount: data.importedCount})
      }
      await refreshProfile()
      showManager()
      showList()
      await loadList()
    } catch (err) {
      log.textContent = t('error_prefix', {msg: err.message || err})
    } finally {
      syncBtn.disabled = false
    }
  })

  composeForm.addEventListener('submit', async (event) => {
    event.preventDefault()
    const to = composeTo.value.trim()
    const subject = composeSubject.value.trim()
    const body = composeBody.value
    if (!to || !subject) {
      log.textContent = t('fill_required')
      return
    }
    try {
      log.textContent = t('sending')
      const payload = { to, subject, text: body }
      await fetchJson('/api/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
      log.textContent = t('send_success')
      composeBody.value = ''
      currentDraftId = null
      switchView('sent')
    } catch (err) {
      log.textContent = t('send_fail', {msg: err.message || err})
    }
  })

  draftRefreshBtn.addEventListener('click', async () => {
    await loadDrafts()
  })

  draftSelect.addEventListener('change', async () => {
    const id = draftSelect.value
    if (!id) return
    await loadDraft(id)
    draftSelect.value = ''
  })

  draftSaveBtn.addEventListener('click', async () => {
    const to = composeTo.value.trim()
    const subject = composeSubject.value.trim()
    if (!to || !subject) {
      alert(t('fill_required_draft'))
      return
    }
    const payload = {
      to,
      subject,
      text: composeBody.value,
      id: currentDraftId || undefined,
    }
    const data = await fetchJson('/api/drafts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
    currentDraftId = data.id
    await loadDrafts()
    alert(t('draft_saved'))
  })

  replyBtn.addEventListener('click', () => {
    if (!currentMessage) return
    const from = currentMessage.from_email || ''
    const subject = currentMessage.subject || ''
    const bodyText = currentMessage.body_text || currentMessage.snippet || ''
    const replySubject = subject.toLowerCase().startsWith('re:') ? subject : t('reply_prefix') + subject
    composeTo.value = from
    composeSubject.value = replySubject
    composeBody.value = t('original_mail') + bodyText
    switchView('compose')
  })

  const appendAgentMessage = (role, text) => {
    const bubble = document.createElement('div')
    bubble.className = `chat-bubble ${role}`
    bubble.textContent = text
    agentMessages.appendChild(bubble)
    agentMessages.scrollTop = agentMessages.scrollHeight
    return bubble
  }

  const extractAgentText = (event) => {
    if (!event || typeof event !== 'object') return ''
    if (event.type === 'text' && typeof event.content === 'string') {
      return event.content
    }
    if (event.type === 'message' && event.message?.role === 'assistant') {
      const parts = Array.isArray(event.message.content) ? event.message.content : []
      return parts
              .map((part) => (part?.type === 'text' ? part.text : ''))
              .filter(Boolean)
              .join('')
    }
    return ''
  }

  const setCurrentAgentSession = (sessionId) => {
    currentAgentSessionId = sessionId
    if (sessionId) {
      localStorage.setItem('agentSessionId', sessionId)
    } else {
      localStorage.removeItem('agentSessionId')
    }
    if (agentSessionSelect) {
      agentSessionSelect.value = sessionId || ''
    }
  }

  const renderAgentHistory = (messages) => {
    agentMessages.innerHTML = ''
    messages.forEach((msg) => {
      const role = msg.role === 'assistant' ? 'agent' : 'user'
      appendAgentMessage(role, msg.content || '')
    })
  }

  const loadAgentHistory = async (sessionId) => {
    if (!sessionId) return
    const data = await fetchJson(`/api/agent/sessions/${sessionId}/messages`)
    renderAgentHistory(data.messages || [])
  }

  const loadAgentSessions = async () => {
    try {
      const data = await fetchJson('/api/agent/sessions')
      const sessions = data.sessions || []
      agentSessionSelect.innerHTML = ''
      sessions.forEach((session) => {
        const option = document.createElement('option')
        option.value = session.id
        option.textContent = session.title || session.id.slice(0, 8)
        agentSessionSelect.appendChild(option)
      })
      const firstId = sessions[0]?.id || null
      const desired = currentAgentSessionId && sessions.some((s) => s.id === currentAgentSessionId)
              ? currentAgentSessionId
              : firstId
      if (desired) {
        setCurrentAgentSession(desired)
        await loadAgentHistory(desired)
      }
    } catch (err) {
      agentSessionSelect.innerHTML = ''
    }
  }

  const createNewAgentSession = async () => {
    const data = await fetchJson('/api/agent/sessions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({}),
    })
    setCurrentAgentSession(data.id)
    await loadAgentSessions()
    await loadAgentHistory(data.id)
  }

  const loadAgentConfig = async () => {
    try {
      const data = await fetchJson('/api/agent/config')
      agentStatus.textContent = data.hasApiKey ? t('agent_configured') : t('agent_not_configured')
      agentHint.textContent = data.hasApiKey ? t('agent_ready') : t('agent_need_config')
      agentApiKey.value = ''
      agentApiKey.placeholder = data.apiKeyMasked || t('agent_not_configured')
      agentBaseUrl.value = data.baseUrl || ''
      agentModel.value = data.model || 'gemini-3'
      agentPrimaryEmail.value = data.primaryEmail || ''
      agentSystemPrompt.value = data.systemPrompt || ''
      chatSend.disabled = !data.hasApiKey
    } catch (err) {
      agentStatus.textContent = t('config_load_fail')
      chatSend.disabled = true
    }
  }

  const saveAgentConfig = async () => {
    try {
      const payload = {
        provider: 'openai',
        apiKey: agentApiKey.value.trim(),
        baseUrl: agentBaseUrl.value.trim(),
        model: agentModel.value.trim(),
        primaryEmail: agentPrimaryEmail.value.trim(),
        systemPrompt: agentSystemPrompt.value.trim(),
      }
      const data = await fetchJson('/api/agent/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      })
      agentStatus.textContent = data.hasApiKey ? t('agent_configured') : t('agent_not_configured')
      agentHint.textContent = data.hasApiKey ? t('agent_ready') : t('agent_need_config')
      agentApiKey.value = ''
      agentApiKey.placeholder = data.apiKeyMasked || t('agent_not_configured')
      chatSend.disabled = !data.hasApiKey
    } catch (err) {
      agentStatus.textContent = t('config_save_fail')
    }
  }

  const stripAnsi = (text) => text.replace(/\u001b\[[0-9;]*m/g, '')

  const streamAgentReply = async (prompt) => {
    if (!currentAgentSessionId) {
      await createNewAgentSession()
    }
    const res = await fetch('/api/agent/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: prompt,
        model: agentModel.value.trim() || undefined,
        sessionId: currentAgentSessionId || undefined,
        currentEmailId: currentMessage?.id || undefined,
      }),
    })

    if (!res.ok) {
      const text = await res.text()
      appendAgentMessage('agent', t('error_prefix', {msg: text}))
      return
    }

    const reader = res.body.getReader()
    const decoder = new TextDecoder()
    let buffer = ''
    let output = ''
    let sawCompleted = false
    const hintMessages = new Set()
    const agentBubble = appendAgentMessage('agent', '')

    const addHintOnce = (hint) => {
      if (hintMessages.has(hint)) return
      hintMessages.add(hint)
      output += `\næç¤ºï¼š${hint}\n`
    }

    const maybeAddHint = (raw) => {
      const text = stripAnsi(String(raw || '')).trim()
      if (!text) return
      if (text.includes('approve-scripts') || text.includes('better-sqlite3')) {
        addHintOnce(t('hint_mcp_approve'))
      }
      if (text.includes('Failed to connect to MCP server') || text.includes('Connection closed')) {
        addHintOnce(t('hint_mcp_connect_fail'))
      }
      if (text.includes('node_modules/.bin/tsx') || text.includes('ENOENT')) {
        addHintOnce(t('hint_install_deps'))
      }
    }

    const processChunk = (chunk) => {
      if (!chunk) return
      const lines = chunk.split('\n').filter(Boolean)
      let eventName = 'message'
      for (const line of lines) {
        const trimmedLine = line.trimStart()
        if (trimmedLine.startsWith('event:')) {
          eventName = trimmedLine.replace(/^event:\s*/, '').trim()
          continue
        }
        if (!trimmedLine.startsWith('data:')) continue
        const payload = trimmedLine.replace(/^data:\s*/, '')
        try {
          const parsed = JSON.parse(payload)
          if (parsed.type === 'event') {
            const text = extractAgentText(parsed.event)
            if (text) {
              if (parsed.event.type === 'message' && output.trim()) {
                // Avoid duplicating final message after streaming tokens.
              } else {
                output += text
              }
            }
            if (parsed.event?.type === 'completed') {
              sawCompleted = true
            }
          } else if (parsed.type === 'start' && parsed.sessionId) {
            setCurrentAgentSession(parsed.sessionId)
          } else if (parsed.type === 'error') {
            maybeAddHint(parsed.error || parsed.message)
            output += t('error_prefix', {msg: parsed.error || parsed.message}) + '\n'
          } else if (parsed.type === 'stderr' || eventName === 'stderr') {
            maybeAddHint(parsed.message || payload)
            output += `stderr: ${parsed.message || payload}\n`
          }
        } catch {
          // Ignore non-JSON frames.
        }
        agentBubble.textContent = output.trim()
      }
    }

    while (true) {
      const { value, done } = await reader.read()
      if (done) break
      buffer += decoder.decode(value, { stream: true })
      buffer = buffer.replace(/\r\n/g, '\n')
      let idx = buffer.indexOf('\n\n')
      while (idx !== -1) {
        const chunk = buffer.slice(0, idx).trim()
        buffer = buffer.slice(idx + 2)
        processChunk(chunk)
        idx = buffer.indexOf('\n\n')
      }
      if (sawCompleted) {
        break
      }
    }

    const leftover = buffer.trim()
    if (leftover) {
      processChunk(leftover)
    }
  }

  agentConfigToggle.addEventListener('click', () => {
    agentConfigPanel.classList.toggle('hidden')
  })

  agentSaveBtn.addEventListener('click', saveAgentConfig)
  agentNewSessionBtn.addEventListener('click', async () => {
    await createNewAgentSession()
  })
  agentSessionSelect.addEventListener('change', async () => {
    const nextId = agentSessionSelect.value
    if (!nextId) return
    setCurrentAgentSession(nextId)
    await loadAgentHistory(nextId)
  })

  chatSend.addEventListener('click', async () => {
    const prompt = chatText.value.trim()
    if (!prompt) return
    appendAgentMessage('user', prompt)
    chatText.value = ''
    chatSend.disabled = true
    try {
      await streamAgentReply(prompt)
    } finally {
      chatSend.disabled = false
    }
  })

  searchBtn.addEventListener('click', async () => {
    const params = new URLSearchParams()
    if (searchFrom.value.trim()) params.set('sender', searchFrom.value.trim())
    if (searchSubject.value.trim()) params.set('subject', searchSubject.value.trim())
    if (searchThread.value.trim()) params.set('thread_id', searchThread.value.trim())
    if (searchMessage.value.trim()) params.set('message_id', searchMessage.value.trim())
    if (!Array.from(params.keys()).length) {
      alert(t('search_no_criteria'))
      return
    }
    try {
      mailList.textContent = t('search_loading')
      const data = await fetchJson(`/api/search?${params.toString()}`)
      renderList(data.messages || [])
      showList()
    } catch (err) {
      mailList.textContent = err.message || err
    }
  })

  pagePrev.addEventListener('click', async () => {
    if (loadingList) return
    if (currentView === 'sent') {
      if (sentPage <= 1) return
      loadingList = true
      sentPage -= 1
      const token = sentPageTokens[sentPage - 1] || null
      try {
        const params = new URLSearchParams({
          from: sentFromInput?.value || '',
          to: sentToInput?.value || '',
          limit: '50',
          t: Date.now().toString(),
        })
        if (token) params.set('pageToken', token)
        const data = await fetchJson(`/api/sent?${params.toString()}`)
        const items = (data.messages || []).map((m) => ({
          ...m,
          from_email: m.to_email ? `To: ${m.to_email}` : t('sent'),
          is_read: 1,
        }))
        sentHasNext = Boolean(data.nextPageToken)
        if (data.nextPageToken) {
          sentPageTokens[sentPage] = data.nextPageToken
        }
        renderList(items)
        pageIndicator.textContent = t('page_num', {page: sentPage})
        pagePrev.disabled = sentPage <= 1
        pageNext.disabled = !sentHasNext
      } catch (err) {
        mailList.textContent = err.message || err
      }
      loadingList = false
      return
    }

    if (inboxPage <= 1) return
    loadingList = true
    try {
      inboxPage -= 1
      inboxOffset = (inboxPage - 1) * inboxLimit
      const params = new URLSearchParams({
        order: orderSelect.value,
        read: readFilter.value,
        priority: priorityFilter.value,
        limit: String(inboxLimit),
        offset: String(inboxOffset),
        t: Date.now().toString(),
      })
      const data = await fetchJson(`/api/messages?${params.toString()}`)
      renderList(data.messages || [])
      pageIndicator.textContent = t('page_num', {page: inboxPage})
      pagePrev.disabled = inboxPage <= 1
      pageNext.disabled = (data.messages || []).length < inboxLimit
    } catch (err) {
      mailList.textContent = err.message || err
    }
    loadingList = false
  })

  pageNext.addEventListener('click', async () => {
    if (loadingList) return
    if (currentView === 'sent') {
      if (!sentHasNext) return
      loadingList = true
      const token = sentPageTokens[sentPage] || null
      try {
        const params = new URLSearchParams({
          from: sentFromInput?.value || '',
          to: sentToInput?.value || '',
          limit: '50',
          t: Date.now().toString(),
        })
        if (token) params.set('pageToken', token)
        const data = await fetchJson(`/api/sent?${params.toString()}`)
        const items = (data.messages || []).map((m) => ({
          ...m,
          from_email: m.to_email ? `To: ${m.to_email}` : t('sent'),
          is_read: 1,
        }))
        sentPage += 1
        sentHasNext = Boolean(data.nextPageToken)
        if (data.nextPageToken) {
          sentPageTokens[sentPage] = data.nextPageToken
        }
        renderList(items)
        pageIndicator.textContent = t('page_num', {page: sentPage})
        pagePrev.disabled = sentPage <= 1
        pageNext.disabled = !sentHasNext
      } catch (err) {
        mailList.textContent = err.message || err
      }
      loadingList = false
      return
    }

    loadingList = true
    try {
      inboxPage += 1
      inboxOffset = (inboxPage - 1) * inboxLimit
      const params = new URLSearchParams({
        order: orderSelect.value,
        read: readFilter.value,
        priority: priorityFilter.value,
        limit: String(inboxLimit),
        offset: String(inboxOffset),
        t: Date.now().toString(),
      })
      const data = await fetchJson(`/api/messages?${params.toString()}`)
      const items = data.messages || []
      renderList(items)
      pageIndicator.textContent = t('page_num', {page: inboxPage})
      pagePrev.disabled = inboxPage <= 1
      pageNext.disabled = items.length < inboxLimit
    } catch (err) {
      mailList.textContent = err.message || err
    }
    loadingList = false
  })

  // å°† internalDateï¼ˆæ¯«ç§’æ—¶é—´æˆ³ï¼‰è½¬æ¢ä¸ºç¾è¥¿æ—¶é—´å¯è¯»æ ¼å¼
  function formatInternalDate(internalDate) {
    if (!internalDate) return t('unknown_date');
    const date = new Date(Number(internalDate));
    return date.toLocaleString('en-US', {
      timeZone: 'America/Los_Angeles',
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function renderList(messages, append = false) {
    if (!append) {
      mailList.innerHTML = ''
    }
    if (!messages.length) {
      mailList.textContent = t('no_mail')
      return
    }
    messages.forEach((msg) => {
      const item = document.createElement('div')
      item.className = 'mail-item'
      item.dataset.id = msg.id
      if (msg.id === activeId) item.classList.add('active')

      const subject = document.createElement('div')
      subject.className = 'mail-subject'
      subject.textContent = msg.subject || t('no_subject')

      // æ·»åŠ ä¼˜å…ˆçº§æ ‡è¯†
      const priorityBadge = document.createElement('span')
      priorityBadge.style.cssText = 'margin-left:8px; font-size:0.75rem; padding:2px 8px; border-radius:12px; font-weight:600;'

      if (msg.priority === 2) {
        priorityBadge.textContent = t('high_priority')
        priorityBadge.style.background = 'rgba(255,59,48,0.15)'
        priorityBadge.style.color = '#ff3b30'
      } else if (msg.priority === 1) {
        priorityBadge.textContent = t('low_priority')
        priorityBadge.style.background = 'rgba(0,0,0,0.05)'
        priorityBadge.style.color = '#666'
      } else if (msg.priority === 0) {
        priorityBadge.textContent = t('not_analyzed')
        priorityBadge.style.background = 'rgba(255,204,0,0.12)'
        priorityBadge.style.color = '#cc8800'
      }

      subject.appendChild(priorityBadge)

      const meta = document.createElement('div')
      meta.className = 'mail-meta'
      const from = document.createElement('span')
      from.textContent = msg.from_email || t('unknown_sender')
      const date = document.createElement('span')
      date.textContent = formatInternalDate(msg.internal_date)
      meta.append(from, date)

      const snippet = document.createElement('div')
      snippet.style.color = 'var(--muted)'
      snippet.style.fontSize = '0.9rem'
      snippet.style.marginTop = '6px'
      snippet.textContent = msg.snippet || ''

      const readStatus = document.createElement('div')
      readStatus.className = 'mail-read'
      readStatus.style.marginTop = '8px'
      const checkbox = document.createElement('input')
      checkbox.type = 'checkbox'
      checkbox.checked = Boolean(msg.is_read)
      checkbox.disabled = true
      const label = document.createElement('span')
      label.textContent = msg.is_read ? ' ' + t('read') : ' ' + t('unread')
      label.style.marginLeft = '4px'
      label.style.fontSize = '0.8rem'
      readStatus.append(checkbox, label)

      item.append(subject, meta, snippet, readStatus)
      item.addEventListener('click', () => loadDetail(msg.id))
      mailList.appendChild(item)
    })
  }

  async function loadList() {
    if (loadingList) return
    loadingList = true
    try {
      mailList.textContent = t('loading')
      inboxPage = 1
      inboxOffset = 0
      const params = new URLSearchParams({
        order: orderSelect.value,
        read: readFilter.value,
        priority: priorityFilter.value,
        limit: String(inboxLimit),
        offset: String(inboxOffset),
        t: Date.now().toString(),
      })
      const data = await fetchJson(`/api/messages?${params.toString()}`)
      renderList(data.messages || [])
      inboxOffset += (data.messages || []).length
      pageIndicator.textContent = t('page_num', {page: inboxPage})
      pagePrev.disabled = inboxPage <= 1
      pageNext.disabled = (data.messages || []).length < inboxLimit
    } catch (err) {
      const msg = t('error_prefix', {msg: err.message || err})
      mailList.textContent = msg
      log.textContent = msg
    }
    loadingList = false
  }

  async function loadSent() {
    if (loadingList) return
    loadingList = true
    try {
      mailList.textContent = t('loading')
      sentPage = 1
      sentPageTokens = [null]
      const params = new URLSearchParams({
        from: sentFromInput?.value || '',
        to: sentToInput?.value || '',
        limit: '50',
        t: Date.now().toString(),
      })
      const data = await fetchJson(`/api/sent?${params.toString()}`)
      const items = (data.messages || []).map((m) => ({
        ...m,
        from_email: m.to_email ? `To: ${m.to_email}` : t('sent'),
        is_read: 1,
      }))
      sentHasNext = Boolean(data.nextPageToken)
      if (data.nextPageToken) {
        sentPageTokens[1] = data.nextPageToken
      }
      renderList(items)
      pageIndicator.textContent = t('page_num', {page: sentPage})
      pagePrev.disabled = sentPage <= 1
      pageNext.disabled = !sentHasNext
    } catch (err) {
      const msg = t('error_prefix', {msg: err.message || err})
      mailList.textContent = msg
      log.textContent = msg
    }
    loadingList = false
  }

  const loadActiveList = () => {
    if (currentView === 'sent') return loadSent()
    return loadList()
  }

  const loadDetail = async (id) => {
    activeId = id
    try {
      detailSubject.textContent = t('loading')
      detailMeta.textContent = ''
      detailBody.textContent = ''
      disableReply()
      const res = await fetch(`/api/messages/${id}`)
      const data = await res.json()
      if (!res.ok) throw new Error(data.error || 'åŠ è½½å¤±è´¥')

      detailSubject.textContent = data.subject || t('no_subject')
      detailMeta.textContent = `${data.from_email || t('unknown_sender')} Â· ${formatInternalDate(data.internal_date)} Â· ${data.is_read ? t('read') : t('unread')}`

      detailBody.innerHTML = ''
      if (data.body_html) {
        const iframe = document.createElement('iframe')
        iframe.setAttribute('sandbox', '')
        iframe.srcdoc = data.body_html
        detailBody.appendChild(iframe)
      } else {
        const pre = document.createElement('pre')
        pre.style.whiteSpace = 'pre-wrap'
        pre.style.margin = '0'
        pre.textContent = data.body_text || data.snippet || ''
        detailBody.appendChild(pre)
      }

      Array.from(mailList.children).forEach((child) => {
        child.classList.toggle('active', child.dataset.id === id)
      })

      currentMessage = data
      replyBtn.disabled = false
      showDetail()
    } catch (err) {
      detailSubject.textContent = t('error')
      detailBody.textContent = err.message || err
    }
  }

  setDefaultRange()
  setDefaultSentRange()
  showHome()
  refreshProfile()
  loadAgentConfig()
  loadAgentSessions()
  loadAutoSyncConfig()
</script>
</body>
</html>